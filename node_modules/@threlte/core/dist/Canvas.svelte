<script context="module">const invalidationHandlers = new Set();
export const invalidateGlobally = (debugFrameloopMessage) => {
    invalidationHandlers.forEach((fn) => fn(debugFrameloopMessage));
};
</script>

<script>import { onDestroy, onMount } from 'svelte';
import { writable } from 'svelte/store';
import { ACESFilmicToneMapping, PCFSoftShadowMap } from 'three';
import T from './components/T/T.svelte';
import { useParentSize } from './hooks/useParentSize';
import { browser } from './lib/browser';
import { createCache } from './lib/cache';
import { createContexts } from './lib/contexts';
import { setDefaultCameraAspectOnSizeChange } from './lib/defaultCamera';
import { useFrameloop } from './lib/useFrameloop';
import { useRenderer } from './lib/useRenderer';
/**
 * @default window.devicePixelRatio
 */
export let dpr = browser ? window.devicePixelRatio : 1;
/**
 * @default ACESFilmicToneMapping
 */
export let toneMapping = ACESFilmicToneMapping;
/**
 * @default 'srgb'
 */
export let colorSpace = 'srgb';
/**
 * @default 'demand'
 */
export let frameloop = 'demand';
/**
 * @default false
 */
export let debugFrameloop = false;
/**
 * @default PCFSoftShadowMap
 */
export let shadows = PCFSoftShadowMap;
export let size = undefined;
export let rendererParameters = undefined;
/**
 * @default true
 */
export let colorManagementEnabled = true;
/**
 * @default true
 */
export let useLegacyLights = true;
let canvas;
let initialized = false;
// user size as a store
const userSize = writable(size);
$: userSize.set(size);
// in case the user didn't define a fixed size, use the parent elements size
const { parentSize, parentSizeAction } = useParentSize();
// creating and setting the contexts
const contexts = createContexts({
    colorSpace,
    toneMapping,
    dpr,
    userSize,
    parentSize,
    debugFrameloop,
    frameloop,
    shadows,
    colorManagementEnabled,
    useLegacyLights
});
// create cache context for caching assets
createCache();
// context bindings
export const ctx = contexts.ctx;
setDefaultCameraAspectOnSizeChange(ctx);
// add invalidation handler to global invalidation handler set
invalidationHandlers.add(ctx.invalidate);
onDestroy(() => {
    invalidationHandlers.delete(ctx.invalidate);
});
// the hook useRenderer is managing the renderer.
const { createRenderer } = useRenderer(ctx);
useFrameloop(contexts.ctx, contexts.internalCtx);
onMount(() => {
    if (!canvas)
        return;
    createRenderer(canvas, rendererParameters);
    initialized = true;
});
onDestroy(() => {
    contexts.internalCtx.dispose(true);
});
</script>

<canvas use:parentSizeAction bind:this={canvas}>
  {#if initialized}
    <T is={contexts.ctx.scene}>
      <slot />
    </T>
  {/if}
</canvas>

<style>
  canvas {
    display: block;
  }
</style>
